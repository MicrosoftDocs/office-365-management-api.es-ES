---
ms.technology: o365-service-communications
ms.TocTitle: Troubleshooting the Office 365 Management Activity API
title: Solución de problemas de la API de actividad de administración de Office 365
description: Resumen de las preguntas más frecuentes que recibe el soporte técnico de Microsoft sobre el uso de esta API.
ms.ContentId: 50822603-a1ec-a754-e7dc-67afe36bb1b0
ms.topic: reference (API)
ms.date: ''
localization_priority: Priority
ms.openlocfilehash: 323407799cefe74b331dec01bb746971c41b5adf
ms.sourcegitcommit: ec60dbd5990cfc61b8c000b423e7ade25fa613a8
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 10/09/2020
ms.locfileid: "48397436"
---
# <a name="office-365-management-activity-api-faqs-and-troubleshooting"></a><span data-ttu-id="8a200-103">Preguntas más frecuentes y solución de problemas sobre la API de Actividad de administración de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-103">Office 365 Management Activity API FAQs and troubleshooting</span></span>

<span data-ttu-id="8a200-104">La API de Actividad de administración de Office 365 (también conocida como la *API de Auditoría unificada*) forma parte de las ofertas de seguridad y cumplimiento de Office 365, que:</span><span class="sxs-lookup"><span data-stu-id="8a200-104">The Office 365 Management Activity API (also known as the *Unified Auditing API*) is a part of Office 365 security and compliance offerings, that:</span></span>

- <span data-ttu-id="8a200-105">Permite el acceso mediante programación a varias cargas de trabajo de canalización de auditoría (como SharePoint y Exchange).</span><span class="sxs-lookup"><span data-stu-id="8a200-105">Allows programmatic access to multiple auditing pipeline workloads (such as SharePoint and Exchange)</span></span>

- <span data-ttu-id="8a200-106">Es la principal interfaz usada por una amplia variedad de productos de proveedores de terceros para agregar e indexar datos de auditoría.</span><span class="sxs-lookup"><span data-stu-id="8a200-106">Is the main interface used by a variety of third-party vendor products to aggregate and index auditing data</span></span>

<span data-ttu-id="8a200-107">La API de actividad de administración no tiene que confundirse con la API de comunicaciones de servicio de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-107">The Management Activity API shouldn't be confused with the Office 365 Service Communications API.</span></span> <span data-ttu-id="8a200-108">La API de actividad de administración se usa para auditar actividades de usuario final en las distintas cargas de trabajo.</span><span class="sxs-lookup"><span data-stu-id="8a200-108">The Management Activity API is for auditing end user activities in the various workloads.</span></span> <span data-ttu-id="8a200-109">La API de comunicaciones de servicio se usa para realizar auditorías de estado y mensajes enviadas por los servicios disponibles en Office 365 (como Dynamics CRM y el servicio de identidad).</span><span class="sxs-lookup"><span data-stu-id="8a200-109">The Service Communications API is for auditing status and messages that are sent by the services that are available in Office 365 (such as Dynamics CRM or Identity Service).</span></span>

## <a name="frequently-asked-questions-about-the-office-365-management-activity-api"></a><span data-ttu-id="8a200-110">Preguntas más frecuentes sobre la API de Actividad de administración de Office 365</span><span class="sxs-lookup"><span data-stu-id="8a200-110">Frequently asked questions about the Office 365 Management Activity API</span></span>

<span data-ttu-id="8a200-111">**¿Cuál es el máximo de tiempo que tendré que esperar antes de que se envíe una notificación sobre un evento específico de Office 365?**</span><span class="sxs-lookup"><span data-stu-id="8a200-111">**What is the maximum time I will have to wait before a notification is sent about a given Office 365 event?**</span></span>

<span data-ttu-id="8a200-112">No hay ninguna latencia máxima garantizada para la entrega de notificaciones (es decir, no existe un contrato de nivel de servicio).</span><span class="sxs-lookup"><span data-stu-id="8a200-112">There is no guaranteed maximum latency for notification delivery (in other words, no SLA).</span></span> <span data-ttu-id="8a200-113">Según la experiencia del Soporte técnico de Microsoft, la mayoría de las notificaciones se enviaron en un plazo de una hora del evento.</span><span class="sxs-lookup"><span data-stu-id="8a200-113">Microsoft Support's experience has been that most notifications are sent within one hour of the event.</span></span> <span data-ttu-id="8a200-114">Con frecuencia, la latencia es mucho más breve, pero también puede ser más larga.</span><span class="sxs-lookup"><span data-stu-id="8a200-114">Often the latency is much shorter, but often it's longer as well.</span></span> <span data-ttu-id="8a200-115">Esto varía según la carga de trabajo; pero, como norma general, la mayoría de las notificaciones se entregarán en un plazo de 24 horas desde que se produjo el evento original.</span><span class="sxs-lookup"><span data-stu-id="8a200-115">This varies somewhat from workload to workload, but a general rule is that most notifications will be delivered within 24 hours of the originating event.</span></span>

<span data-ttu-id="8a200-116">**¿Las notificaciones de webhook son más inmediatas? Después de todo, ¿no están controlados por eventos?**</span><span class="sxs-lookup"><span data-stu-id="8a200-116">**Aren't webhook notifications more immediate? After all, aren't they are event-driven?**</span></span>

<span data-ttu-id="8a200-117">No.</span><span class="sxs-lookup"><span data-stu-id="8a200-117">No.</span></span><span data-ttu-id="8a200-118">Las notificaciones de webhook no están controladas por eventos en el sentido de que el evento desencadena la notificación.</span><span class="sxs-lookup"><span data-stu-id="8a200-118"> Webhook notifications aren't event-driven in the sense that the event triggers the notification.</span></span> <span data-ttu-id="8a200-119">Sigue siendo necesario crear el blob de contenido, y la creación del valor de contenido es lo que desencadena la entrega de notificaciones.</span><span class="sxs-lookup"><span data-stu-id="8a200-119">The content blob must still be created and creating the content blob is what triggers the notification delivery.</span></span> <span data-ttu-id="8a200-120">Recientemente, se produjeron tiempos de espera más largos para las notificaciones al usar un webhook, en comparación con las consultas a la API realizadas directamente con la operación /content.</span><span class="sxs-lookup"><span data-stu-id="8a200-120">Recently, there have been longer wait times for notifications when using a webhook compared to querying the API directly with the /content operation.</span></span> <span data-ttu-id="8a200-121">Por lo tanto, la API de actividad de administración no tiene que considerarse un sistema de alertas de seguridad en tiempo real.</span><span class="sxs-lookup"><span data-stu-id="8a200-121">Therefore, the Management Activity API shouldn't be thought of as a real-time security alert system.</span></span> <span data-ttu-id="8a200-122">Microsoft ofrece otros productos para eso.</span><span class="sxs-lookup"><span data-stu-id="8a200-122">Microsoft has other products for that.</span></span> <span data-ttu-id="8a200-123">En relación con la seguridad, las notificaciones de eventos de la API de actividad de administración pueden ser más apropiadas cuando se usan para determinar patrones de uso en períodos prolongados.</span><span class="sxs-lookup"><span data-stu-id="8a200-123">As far as security is concerned, Management Activity API event notifications can more appropriately be used to determine use patterns over extended periods of time.</span></span>

<span data-ttu-id="8a200-124">**¿Puedo realizar consultas a la API de actividad de administración para un id. de evento o elemento RecordType específicos, o bien otras propiedades del blob de contenido?**</span><span class="sxs-lookup"><span data-stu-id="8a200-124">**Can I query the Management Activity API for a particular event ID or RecordType or other properties in the content blob?**</span></span>

<span data-ttu-id="8a200-125">No.</span><span class="sxs-lookup"><span data-stu-id="8a200-125">No.</span></span><span data-ttu-id="8a200-126">No piense que los datos disponibles mediante la API de actividad de administración se “registran” en el sentido tradicional.</span><span class="sxs-lookup"><span data-stu-id="8a200-126"> Don't think of the data available through the Management Activity API as being a “log” in the traditional sense.</span></span> <span data-ttu-id="8a200-127">En su lugar, piense en esto como un volcado de los detalles del evento.</span><span class="sxs-lookup"><span data-stu-id="8a200-127">Rather, think of it as a dump of event details.</span></span> <span data-ttu-id="8a200-128">Tiene que decidir si quiere recopilar todos los detalles de los eventos, almacenarlos e indexarlos localmente y, después, implementar su propia lógica de consulta con una aplicación personalizada o una herramienta de terceros.</span><span class="sxs-lookup"><span data-stu-id="8a200-128">It's up to you to gather all those event details, store and index them locally, and then implement your own query logic, by using either a custom application or a third-party tool.</span></span>

<span data-ttu-id="8a200-129">**¿Cómo sé que los datos que provienen de mi solución de auditoría existente, que recopila datos de la API de actividad de administración, son precisos y completos?**</span><span class="sxs-lookup"><span data-stu-id="8a200-129">**How do I know the data coming from my existing auditing solution, which collects data from the Management Activity API, is accurate and complete?**</span></span>

<span data-ttu-id="8a200-130">La respuesta breve es que Microsoft no ofrece ningún tipo de registro que le permita realizar una comprobación cruzada de una aplicación específica o una aplicación de terceros (ISV).</span><span class="sxs-lookup"><span data-stu-id="8a200-130">The short answer is that Microsoft doesn't provide any kind of a log that will allow you to cross-check any given application or third-party (ISV) application.</span></span> <span data-ttu-id="8a200-131">Hay otros productos de seguridad de Microsoft que obtienen sus datos de la misma canalización, pero esos productos se encuentran fuera del ámbito de esta explicación y no pueden usarse para realizar una comprobación cruzada directamente de la API de actividad de administración.</span><span class="sxs-lookup"><span data-stu-id="8a200-131">There are other Microsoft security products that draw their data from the same pipeline, but those products fall outside the scope of this discussion and can't be used to directly cross-check the Management Activity API.</span></span> <span data-ttu-id="8a200-132">Si quiere conocer las posibles discrepancias entre los datos que proporciona su solución existente y los datos esperados, le recomendamos que implemente las operaciones indicadas anteriormente.</span><span class="sxs-lookup"><span data-stu-id="8a200-132">If you're concerned about discrepancies between what your existing solution is providing and what you expect, you should implement the operations illustrated above.</span></span> <span data-ttu-id="8a200-133">Pero esto puede resultar difícil, según la forma en que la herramienta o solución existente muestre una lista de los datos y los indexe.</span><span class="sxs-lookup"><span data-stu-id="8a200-133">But this can be difficult, depending on how your existing tool or solution lists and indexes data.</span></span> <span data-ttu-id="8a200-134">Si la solución existente solo presenta datos ordenados por la hora de creación del evento en sí, no existe ninguna forma de consultar la API mediante la hora de creación del evento para que pueda comparar los conjuntos de resultados.</span><span class="sxs-lookup"><span data-stu-id="8a200-134">If your existing solution only presents data sorted by the creation time of the actual event, there's no way to query the API by event creation time so that you could compare result sets.</span></span> <span data-ttu-id="8a200-135">En este escenario, tendrá que recopilar los blobs de contenido notificados durante varios días, indexarlos u ordenarlos de forma manual y, después, realizar una comparación aproximada.</span><span class="sxs-lookup"><span data-stu-id="8a200-135">In this scenario, you'd have to collect the notified content blobs for several days, index or sort them manually, and then do a rough comparison.</span></span>

<span data-ttu-id="8a200-136">**¿Durante cuánto tiempo estarán disponibles los blobs de contenido?**</span><span class="sxs-lookup"><span data-stu-id="8a200-136">**How long will the content blobs remain available?**</span></span>

<span data-ttu-id="8a200-137">Los blobs de contenido están disponibles durante siete días después de la disponibilidad de la notificación del bloque de contenido.</span><span class="sxs-lookup"><span data-stu-id="8a200-137">Content blobs are available 7 days after the notification of the content blob's availability.</span></span> <span data-ttu-id="8a200-138">Esto quiere decir que, si se produce un retraso significativo en la creación del blob de contenido, dispondrá de más tiempo (el retraso más siete días) después de la fecha de creación del evento real antes de que el valor de contenido deje de estar disponible.</span><span class="sxs-lookup"><span data-stu-id="8a200-138">This means that if there is a significant delay in the creation of the content blob, you will have more time (the delay plus 7 days) after the actual event creation date before the content blob is no longer available.</span></span>

<span data-ttu-id="8a200-139">**Si se produce un retraso de 24 horas al obtener una notificación, ¿no quiere decir que solo dispondré de seis días para recuperar el blob de contenido?**</span><span class="sxs-lookup"><span data-stu-id="8a200-139">**If there is a 24-hour delay in getting a notification, doesn't that mean I will have only 6 days to retrieve the content blob?**</span></span>

<span data-ttu-id="8a200-140">No.</span><span class="sxs-lookup"><span data-stu-id="8a200-140">No.</span></span><span data-ttu-id="8a200-141">Incluso si la notificación se retrasa durante un período inusualmente largo (por ejemplo, en el caso de una interrupción del servicio), seguiría disponiendo de siete días después de la primera disponibilidad de la notificación para descargar el blob de contenido relacionado con el evento original.</span><span class="sxs-lookup"><span data-stu-id="8a200-141"> Even if the notification is delayed for an unusually long period (for example, in the case of a service interruption), you would still have 7 days after the first availability of the notification to download the content blob related to the originating event.</span></span>

<span data-ttu-id="8a200-142">**¿Qué eventos se auditan para un servicio de Office 365 específico?**</span><span class="sxs-lookup"><span data-stu-id="8a200-142">**What events are audited for a specific Office 365 service?**</span></span>

<span data-ttu-id="8a200-143">La documentación del esquema de la API de Actividad de administración de Office 365 contiene una lista completa de eventos.</span><span class="sxs-lookup"><span data-stu-id="8a200-143">Office 365 Management Activity API schema documentation has a comprehensive list of events.</span></span> <span data-ttu-id="8a200-144">Para obtener más información, vea Esquema de la API de Actividad de administración de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-144">For details, see Office 365 Management Activity API schema.</span></span> <span data-ttu-id="8a200-145">Vea también la sección "Actividades auditadas" en Buscar el registro de auditoría en el Centro de cumplimiento y seguridad para obtener una lista de los eventos de mayor servicio de Office 365 que se auditan.</span><span class="sxs-lookup"><span data-stu-id="8a200-145">Also see the “Audited activities” section in Search the audit log in the Security & Compliance Center for a list of events for most of the Office 365 services that are audited.</span></span>

<span data-ttu-id="8a200-146">**¿Cómo incorporo la API de actividad de administración?**</span><span class="sxs-lookup"><span data-stu-id="8a200-146">**How do I onboard to the Management Activity API?**</span></span>

<span data-ttu-id="8a200-147">Para empezar a usar la API de Actividad de administración de Office 365, vea Introducción a las API de administración de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-147">To get started with the Office 365 Management Activity API, see Get started with Office 365 Management APIs.</span></span>

<span data-ttu-id="8a200-148">**Queremos capturar mediante programación todos los eventos de todas las cargas de trabajo. ¿Cuál es la forma más confiable de hacerlo?**</span><span class="sxs-lookup"><span data-stu-id="8a200-148">**We want to programmatically capture all events in all workloads. What is the most reliable way to do this?**</span></span>

<span data-ttu-id="8a200-149">Puede hacerlo con las API de actividad de administración de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-149">You can do this by using the Office 365 Management Activity API.</span></span> <span data-ttu-id="8a200-150">Además, le recomendamos que use el **modelo de extracción** debido a los problemas relacionados con el uso de webhooks.</span><span class="sxs-lookup"><span data-stu-id="8a200-150">Also, we recommend that you use the **pull model** due to issues with using webhooks.</span></span> <span data-ttu-id="8a200-151">Para obtener más información, vea la sección “Uso de webhooks” en Solución de problemas de la API de Actividad de administración de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-151">For more information, see the “Using webhooks” section in Troubleshooting the Office 365 Management Activity API.</span></span>

<span data-ttu-id="8a200-152">**¿Hay alguna diferencia entre los registros obtenidos por la API de actividad de administración y los registros obtenidos con la herramienta de búsqueda de registros de auditoría del Centro de cumplimiento de Microsoft 365?**</span><span class="sxs-lookup"><span data-stu-id="8a200-152">**Are there any differences in the records that are fetched by the Management Activity API versus the records that are returned by using the audit log search tool in the Microsoft 365 compliance center?**</span></span>

<span data-ttu-id="8a200-153">Los datos obtenidos por ambos métodos son los mismos.</span><span class="sxs-lookup"><span data-stu-id="8a200-153">The data that is returned by both methods is the same.</span></span> <span data-ttu-id="8a200-154">No se realiza ningún tipo de filtrado.</span><span class="sxs-lookup"><span data-stu-id="8a200-154">There is no filtering that happens.</span></span> <span data-ttu-id="8a200-155">La única diferencia es que la API obtiene datos de los últimos siete días en cada operación.</span><span class="sxs-lookup"><span data-stu-id="8a200-155">The only difference is that with the API, you can get data for the last 7 days at a time.</span></span> <span data-ttu-id="8a200-156">Al realizar búsquedas en los registros de auditoría desde el Centro de seguridad y cumplimiento (o con el cmdlet correspondiente Search-UnifiedAuditLog en Exchange Online), se pueden obtener datos de los últimos 90 días.</span><span class="sxs-lookup"><span data-stu-id="8a200-156">When searching the audit log in the Security & Compliance Center (or by using the corresponding Search-UnifiedAuditLog cmdlet in Exchange Online), you can get data for the last 90 days.</span></span>

<span data-ttu-id="8a200-157">**¿Qué ocurre si deshabilito la auditoría en la organización Microsoft Office 365? ¿Seguiré apareciendo eventos mediante la API de Actividad de administración?**</span><span class="sxs-lookup"><span data-stu-id="8a200-157">**What happens if I disable auditing for my Office 365 organization? Will I still get events via the Management Activity API?**</span></span>

<span data-ttu-id="8a200-158">No.</span><span class="sxs-lookup"><span data-stu-id="8a200-158">No.</span></span><span data-ttu-id="8a200-159">La auditoría unificada de Office 365 debe estar habilitada para que su organización pueda extraer registros a través de la API de Actividad de administración.</span><span class="sxs-lookup"><span data-stu-id="8a200-159"> Office 365 unified auditing must be enabled for your organization to pull records via the Management Activity API.</span></span> <span data-ttu-id="8a200-160">Para obtener instrucciones, consulte Activar o desactivar la búsqueda de registros de auditoría de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-160">For instructions, see Turn Office 365 audit log search on or off.</span></span>

<span data-ttu-id="8a200-161">**¿Cuál es el límite para la API de actividad de administración?**</span><span class="sxs-lookup"><span data-stu-id="8a200-161">**What is the throttling limit for the Management Activity API?**</span></span>

<span data-ttu-id="8a200-162">Se asigna inicialmente una línea base de 2 000 solicitudes por minuto a todas las organizaciones.</span><span class="sxs-lookup"><span data-stu-id="8a200-162">All organizations are initially allocated a baseline of 2,000 requests per minute.</span></span> <span data-ttu-id="8a200-163">Este no es un límite estático y predefinido, sino que se modela en base a una combinación de factores, incluido el número de puestos en la organización, y que las organizaciones de Office 365 E5 y Microsoft 365 E5 tendrán aproximadamente el doble de ancho de banda que las organizaciones que no son E5.</span><span class="sxs-lookup"><span data-stu-id="8a200-163">This is not a static, predefined limit but is modeled on a combination of factors including the number of seats in the organization and the fact that Office 365 E5 and Microsoft 365 E5 organizations will get approximately twice as much bandwidth as non-E5 organizations.</span></span> <span data-ttu-id="8a200-164">También habrá un límite en el ancho de banda máximo para proteger el estado del servicio.</span><span class="sxs-lookup"><span data-stu-id="8a200-164">There will also be cap on the maximum bandwidth to protect the health of the service.</span></span>

> [!NOTE]
> <span data-ttu-id="8a200-165">Aunque cada espacio empresarial puede enviar en un principio hasta 2 000 solicitudes por minuto, Microsoft no garantiza una velocidad de respuesta.</span><span class="sxs-lookup"><span data-stu-id="8a200-165">Even though each tenant can initially submit up to 2,000 requests per minute, Microsoft cannot guarantee a response rate.</span></span> <span data-ttu-id="8a200-166">La velocidad de respuesta depende de varios factores, como el rendimiento del sistema cliente y la capacidad y la velocidad de la red.</span><span class="sxs-lookup"><span data-stu-id="8a200-166">The response rate depends on various factors, such as client system performance, network capacity, and network speed.</span></span>

<span data-ttu-id="8a200-167">**Veo un error de limitación en la API de actividad de administración.**</span><span class="sxs-lookup"><span data-stu-id="8a200-167">**I'm encountering a throttling error in the Management Activity API. What should I do?**</span></span>

<span data-ttu-id="8a200-168">Abra una incidencia con el Soporte técnico de Microsoft y solicite un nuevo límite, e incluya una justificación empresarial para incrementar el límite.</span><span class="sxs-lookup"><span data-stu-id="8a200-168">Open a ticket with Microsoft Support and request a new throttling limit, and include a business justification for increasing the limit.</span></span> <span data-ttu-id="8a200-169">Evaluaremos la solicitud y, si es aceptada, incrementaremos el límite.</span><span class="sxs-lookup"><span data-stu-id="8a200-169">We will evaluate the request, and if accepted, we will increase the throttling limit.</span></span>

<span data-ttu-id="8a200-170">**¿Por qué TargetUpdatedProperties ya no están en ExtendedProperties en los registros de auditoría de actividades de Azure Active Directory?**</span><span class="sxs-lookup"><span data-stu-id="8a200-170">**Why are TargetUpdatedProperties no longer in ExtendedProperties in the audit logs for Azure Active Directory activities?**</span></span>

<span data-ttu-id="8a200-171">TargetUpdatedProperties aparecían en ExtendedProperties.</span><span class="sxs-lookup"><span data-stu-id="8a200-171">TargetUpdatedProperties were appearing in ExtendedProperties.</span></span> <span data-ttu-id="8a200-172">Sin embargo, se han quitado de Propiedades extensas y ahora aparecerán en Propiedades modificadas.</span><span class="sxs-lookup"><span data-stu-id="8a200-172">However, they have been removed from ExtendedProperties and now appear in ModifiedProperties.</span></span>

## <a name="troubleshooting-the-office-365-management-activity-api"></a><span data-ttu-id="8a200-173">Solución de problemas de la API de Actividad de administración de Office 365</span><span class="sxs-lookup"><span data-stu-id="8a200-173">Troubleshooting the Office 365 Management Activity API</span></span>

<span data-ttu-id="8a200-174">Una cosa que debe quedar clara para cualquiera que esté comenzando con la API de Actividad de administración de Office 365 es que no existe un concepto de consulta por eventos específicos, como la fecha en que ocurrió el evento, desde qué colección de sitios se podría haber disparado un evento, o el tipo de evento.</span><span class="sxs-lookup"><span data-stu-id="8a200-174">One thing that should be made clear for anyone who's getting started with the Office 365 Management Activity API is that there is no concept of querying by event specifics, such as date that the event occurred, which site collection an event might have been fired from, or the type of event.</span></span> <span data-ttu-id="8a200-175">En su lugar, se crean suscripciones a cargas de trabajo específicas (por ejemplo, SharePoint o Azure AD) y cada suscripción se corresponde con un espacio empresarial.</span><span class="sxs-lookup"><span data-stu-id="8a200-175">Instead, you create subscriptions to specific workloads (for example, SharePoint or Azure AD) and each subscription is per tenant.</span></span>

<span data-ttu-id="8a200-176">En las secciones siguientes se resumen las preguntas más frecuentes que tienen los clientes en el uso de la API de Actividad de administración de Office 365:</span><span class="sxs-lookup"><span data-stu-id="8a200-176">The following sections summarizes the most common questions that customers have in using the Office 365 Management Activity API:</span></span>

- [<span data-ttu-id="8a200-177">Preguntas sobre clientes y herramientas de terceros</span><span class="sxs-lookup"><span data-stu-id="8a200-177">Questions about third-party tools and clients</span></span>](#questions-about-third-party-tools-and-clients)

- [<span data-ttu-id="8a200-178">Habilitar el registro de auditoría unificado en Office 365</span><span class="sxs-lookup"><span data-stu-id="8a200-178">Enabling unified audit logging in Office 365</span></span>](#enabling-unified-audit-logging-in-office-365)

- [<span data-ttu-id="8a200-179">Conectarse a la API</span><span class="sxs-lookup"><span data-stu-id="8a200-179">Connecting to the API</span></span>](#connecting-to-the-api)

- [<span data-ttu-id="8a200-180">Comprobar las suscripciones</span><span class="sxs-lookup"><span data-stu-id="8a200-180">Checking your subscriptions</span></span>](#checking-your-subscriptions)

- [<span data-ttu-id="8a200-181">Crear una suscripción</span><span class="sxs-lookup"><span data-stu-id="8a200-181">Creating a new subscription</span></span>](#creating-a-new-subscription)

- [<span data-ttu-id="8a200-182">Uso de webhooks</span><span class="sxs-lookup"><span data-stu-id="8a200-182">Using webhooks</span></span>](#using-webhooks)

- [<span data-ttu-id="8a200-183">Solicitar blobs de contenido y limitación</span><span class="sxs-lookup"><span data-stu-id="8a200-183">Requesting content blobs and throttling</span></span>](#requesting-content-blobs-and-throttling)

<span data-ttu-id="8a200-184">Le mostraremos una selección de scripts de PowerShell sencillos que pueden ayudarle a responder a las preguntas más frecuentes realizadas por los clientes o que pueden permitirle empezar a implementar una solución personalizada al mostrar una demostración de las operaciones principales.</span><span class="sxs-lookup"><span data-stu-id="8a200-184">We'll show a selection of simple PowerShell scripts that can help you answer the most common questions asked by customers or get you started implementing a custom solution by demonstrating the main operations.</span></span> <span data-ttu-id="8a200-185">No todas las operaciones se explican en estas secciones, pero todas se enumeran en la referencia de API de Actividad de administración de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-185">Not all the operations are explained in these sections, but they are all listed in Office 365 Management Activity API reference.</span></span>

### <a name="questions-about-third-party-tools-and-clients"></a><span data-ttu-id="8a200-186">Preguntas sobre clientes y herramientas de terceros</span><span class="sxs-lookup"><span data-stu-id="8a200-186">Questions about third-party tools and clients</span></span>

<span data-ttu-id="8a200-187">La categoría de preguntas más común proviene de clientes que utilizan productos de terceros para descargar y agregar datos de auditoría.</span><span class="sxs-lookup"><span data-stu-id="8a200-187">The most common category of questions come from customers using third-party products to download and aggregate auditing data.</span></span> <span data-ttu-id="8a200-188">Según el producto de terceros usado, los clientes pueden encontrar dificultades con la configuración o experimentar una interrupción o incoherencias en los datos expuestos en estos productos.</span><span class="sxs-lookup"><span data-stu-id="8a200-188">Depending on the third-party product, customers may encounter difficulty with the setup or experience an interruption or an inconsistency in the data exposed in those products.</span></span> <span data-ttu-id="8a200-189">Es importante conocer que la primera acción que necesitan realizar esos clientes es ponerse en contacto con la organización de soporte técnico de su proveedor.</span><span class="sxs-lookup"><span data-stu-id="8a200-189">Here it should be stated that the first action such customers should take is to contact their vendor's support organization.</span></span> <span data-ttu-id="8a200-190">Normalmente, un problema con el servicio o la configuración de un proveedor específico del espacio empresarial es la causa de las quejas de clientes.</span><span class="sxs-lookup"><span data-stu-id="8a200-190">Typically, a tenant-specific vendor configuration or service problem is the cause of customer complaints.</span></span>

### <a name="enabling-unified-audit-logging-in-office-365"></a><span data-ttu-id="8a200-191">Habilitar el registro de auditoría unificado en Office 365</span><span class="sxs-lookup"><span data-stu-id="8a200-191">Enabling unified audit logging in Office 365</span></span>

<span data-ttu-id="8a200-192">Si acaba de configurar una aplicación que está intentando usar la API de Actividad de administración y no funciona, asegúrese de que ha habilitado el registro de auditoría unificado para su organización de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-192">If you've just set up an app that's trying to use the Management Activity API and it's not working, be sure that you've enabled unified audit logging for your Office 365 organization.</span></span> <span data-ttu-id="8a200-193">Para ello, active el registro de auditoría de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-193">You do this by turning on the Office 365 audit log.</span></span> <span data-ttu-id="8a200-194">Para obtener instrucciones, consulte [Activar o desactivar la búsqueda de registros de auditoría de Office 365](https://docs.microsoft.com/office365/securitycompliance/turn-audit-log-search-on-or-off).</span><span class="sxs-lookup"><span data-stu-id="8a200-194">For instructions, see [Turn Office 365 audit log search on or off](https://docs.microsoft.com/office365/securitycompliance/turn-audit-log-search-on-or-off).</span></span>

<span data-ttu-id="8a200-195">Si la auditoría unificada no está habilitada, normalmente se producirá un error que contiene la siguiente cadena: `Microsoft.Office.Compliance.Audit``.DataServiceException: Tenant <tenantID> does not exist.`</span><span class="sxs-lookup"><span data-stu-id="8a200-195">If unified auditing isn't enabled, you will typically receive an error that contains the following string: `Microsoft.Office.Compliance.Audit``.DataServiceException: Tenant <tenantID> does not exist.`</span></span>

### <a name="connecting-to-the-api"></a><span data-ttu-id="8a200-196">Conectarse a la API</span><span class="sxs-lookup"><span data-stu-id="8a200-196">Connecting to the API</span></span>

<span data-ttu-id="8a200-197">La mayoría de las aplicaciones se conectan a la API con un flujo sencillo de OAuth2 de credenciales de cliente.</span><span class="sxs-lookup"><span data-stu-id="8a200-197">Most applications connect to the API using a straightforward Client Credentials OAuth2 flow.</span></span> <span data-ttu-id="8a200-198">Por lo tanto, el primer paso es crear una aplicación de Azure AD que tenga los permisos necesarios para obtener acceso a los datos de la API de actividad de administración.</span><span class="sxs-lookup"><span data-stu-id="8a200-198">Therefore, the first step is to create an Azure AD application that has the permissions needed to access the Management Activity API data.</span></span> <span data-ttu-id="8a200-199">La explicación de los pasos para crear un registro de aplicación de Azure AD está fuera del ámbito de este artículo.</span><span class="sxs-lookup"><span data-stu-id="8a200-199">It's outside the scope of this article to explain the steps to create an Azure AD App registration.</span></span> <span data-ttu-id="8a200-200">Para obtener más información, vea [Registrar la aplicación con el espacio empresarial de Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications).</span><span class="sxs-lookup"><span data-stu-id="8a200-200">For more information, see [Register your application with your Azure Active Directory tenant](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications).</span></span>

#### <a name="azure-application-permissions"></a><span data-ttu-id="8a200-201">Permisos de aplicación de Azure</span><span class="sxs-lookup"><span data-stu-id="8a200-201">Azure application permissions</span></span>

<span data-ttu-id="8a200-202">Los tres permisos usados actualmente para la API de actividad de administración de Office 365 son las siguientes:</span><span class="sxs-lookup"><span data-stu-id="8a200-202">The three permissions currently used for the Office 365 Management Activity API are:</span></span>

1. <span data-ttu-id="8a200-203">Leer datos de actividad de la organización.</span><span class="sxs-lookup"><span data-stu-id="8a200-203">Read activity data for your organization</span></span>

2. <span data-ttu-id="8a200-204">Leer información de estado del servicio de la organización.</span><span class="sxs-lookup"><span data-stu-id="8a200-204">Read service health information for your organization</span></span>

3. <span data-ttu-id="8a200-205">Leer eventos de directiva de prevención de pérdida de datos (DLP), incluida información confidencial detectada.</span><span class="sxs-lookup"><span data-stu-id="8a200-205">Read Data Loss Prevention (DLP) policy events, including detected sensitive information</span></span>

> [!NOTE]
> <span data-ttu-id="8a200-206">Necesita habilitar los permisos de aplicación y los permisos delegados como mínimo para los primeros dos conjuntos de permisos anteriores.</span><span class="sxs-lookup"><span data-stu-id="8a200-206">You should enable both the Application Permissions and the Delegated Permissions for at least the first two of the above permission sets.</span></span> <span data-ttu-id="8a200-207">Leer eventos de directiva DLP solo será necesario si está interesado en las cargas de trabajo de DLP.</span><span class="sxs-lookup"><span data-stu-id="8a200-207">Read DLP policy events will only be necessary if you are interested in the DLP workloads.</span></span>

#### <a name="getting-an-access-token"></a><span data-ttu-id="8a200-208">Obtener un token de acceso</span><span class="sxs-lookup"><span data-stu-id="8a200-208">Getting an access token</span></span>

<span data-ttu-id="8a200-209">El siguiente script de PowerShell usa el id. de aplicación y el secreto de cliente para obtener el token de OAuth2 desde el punto de conexión de autenticación de la API de actividad de administración.</span><span class="sxs-lookup"><span data-stu-id="8a200-209">The following PowerShell script uses the App ID and a Client Secret to obtain the OAuth2 token from the Management Activity API authentication endpoint.</span></span> <span data-ttu-id="8a200-210">Después, coloque el token de acceso en la variable de la matriz `$headerParams`, que se adjuntará a la solicitud HTTP:</span><span class="sxs-lookup"><span data-stu-id="8a200-210">It then places the access token into the `$headerParams` array variable, which you'll attach to your HTTP request.</span></span> <span data-ttu-id="8a200-211">Para el valor del punto de conexión de la API (en la variable $resource), use uno de los siguientes valores según el plan de suscripción de Microsoft 365 u Office 365 de su organización:</span><span class="sxs-lookup"><span data-stu-id="8a200-211">For the value for the API endpoint (in the $resource variable) use one of the following values based on your organization's Microsoft 365 or Office 365 subscription plan:</span></span>

- <span data-ttu-id="8a200-212">Plan para empresas: `manage.office.com`</span><span class="sxs-lookup"><span data-stu-id="8a200-212">Enterprise plan: `manage.office.com`</span></span>

- <span data-ttu-id="8a200-213">Plan de Administración pública GCC: `manage-gcc.office.com`</span><span class="sxs-lookup"><span data-stu-id="8a200-213">GCC government plan: `manage-gcc.office.com`</span></span>

- <span data-ttu-id="8a200-214">Plan de Administración pública GCC High: `manage.office365.us`</span><span class="sxs-lookup"><span data-stu-id="8a200-214">GCC High government plan: `manage.office365.us`</span></span>

- <span data-ttu-id="8a200-215">Plan de Administración pública DoD: `manage.protection.apps.mil`</span><span class="sxs-lookup"><span data-stu-id="8a200-215">DoD government plan: `manage.protection.apps.mil`</span></span>

```powershell
# Create app of type Web app / API in Azure AD, generate a Client Secret, and update the client id and client secret here
$ClientID = "<YOUR_APPLICATION_ID"
$ClientSecret = "<YOUR_CLIENT_SECRET>"
$loginURL = "https://login.microsoftonline.com/"
$tenantdomain = "<YOUR_DOMAIN>.onmicrosoft.com"
# Get the tenant GUID from Properties | Directory ID under the Azure Active Directory section. For $resource, use one of these endpoint values based on your subscription plan: Enterprise - manage.office.com; GCC - manage-gcc.office.com; GCC High: manage.office365.us; DoD: manage.protection.apps.mil
$TenantGUID = "<YOUR_TENANT_GUID>"
$resource = "https://<YOUR_API_ENDPOINT>"
# auth
$body = @{grant_type="client_credentials";resource=$resource;client_id=$ClientID;client_secret=$ClientSecret}
$oauth = Invoke-RestMethod -Method Post -Uri $loginURL/$tenantdomain/oauth2/token?api-version=1.0 -Body $body
$headerParams = @{'Authorization'="$($oauth.token_type) $($oauth.access_token)"} 
```

<span data-ttu-id="8a200-216">La variable `$oauth` contendrá el objeto response, que tiene varias propiedades, incluido el token de acceso.</span><span class="sxs-lookup"><span data-stu-id="8a200-216">The `$oauth` variable will contain the response object, which has several properties including the access token.</span></span> <span data-ttu-id="8a200-217">Un ejemplo de respuesta es:</span><span class="sxs-lookup"><span data-stu-id="8a200-217">Here's an example of a response:</span></span>

```json
token_type     : Bearer
expires_in     : 3599
ext_expires_in : 0
expires_on     : 1508285860
not_before     : 1508281960
resource       : https://manage.office.com
access_token   : eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyIsImtpZCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyJ9.eyJhdWQiOiJodHRwczov…
```

### <a name="checking-your-subscriptions"></a><span data-ttu-id="8a200-218">Comprobar las suscripciones</span><span class="sxs-lookup"><span data-stu-id="8a200-218">Checking your subscriptions</span></span>

<span data-ttu-id="8a200-219">Si ha experimentado una interrupción del flujo de datos a un cliente o una solución de la API de actividad de administración existente, puede que se pregunte si hubo algún problema con la suscripción.</span><span class="sxs-lookup"><span data-stu-id="8a200-219">If you've experienced an interruption in data flowing to an existing Management Activity API client or solution, you might wonder if something happened to your subscription.</span></span> <span data-ttu-id="8a200-220">Para comprobar las suscripciones activas, agregue lo siguiente al script anterior:</span><span class="sxs-lookup"><span data-stu-id="8a200-220">To check your active subscriptions, add the following to the previous script:</span></span>

```powershell
Invoke-WebRequest -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/list" 
```

#### <a name="sample-response"></a><span data-ttu-id="8a200-221">Respuesta de ejemplo</span><span class="sxs-lookup"><span data-stu-id="8a200-221">Sample response</span></span>

```json
StatusCode        : 200
Status Description : OK
Content           : [{"contentType":"Audit.Exchange","status":"enabled","webhook":null},{"contentType":"Audit.SharePoint","status":"enabled","webhook":{"authId":"","address":"https://mvcwebapiwebhookreceiver.azurewebsite...
RawContent        : HTTP/1.1 200 OK
                    Pragma: no-cache
                    Content-Length: 266
                    Cache-Control: no-cache
                    Content-Type: application/json; charset=utf-8
                    Expires: -1
                    Server: Microsoft-IIS/8.5,Microsoft-IIS/8.5
                    X-AspNet-Versi...
Forms             : {}
Headers           : {[Pragma, no-cache], [Content-Length, 266], [Cache-Control, no-cache], [Content-Type, application/json; charset=utf-8]...}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 266
```

<span data-ttu-id="8a200-222">Esto indica que el espacio empresarial tiene habilitadas las suscripciones Audit.Exchange y Audit.SharePoint.</span><span class="sxs-lookup"><span data-stu-id="8a200-222">This says that the tenant has both Audit.Exchange and Audit.SharePoint subscriptions enabled.</span></span> <span data-ttu-id="8a200-223">La suscripción de Exchange no tiene habilitado ningún webhook (nulo) y la suscripción de SharePoint tiene habilitado un webhook, donde se muestra la dirección del punto de conexión registrado.</span><span class="sxs-lookup"><span data-stu-id="8a200-223">The Exchange subscription has no webhook enabled (null) and the SharePoint subscription has a webhook enabled with the address of the registered endpoint shown.</span></span>

### <a name="creating-a-new-subscription"></a><span data-ttu-id="8a200-224">Crear una suscripción</span><span class="sxs-lookup"><span data-stu-id="8a200-224">Creating a new subscription</span></span>

<span data-ttu-id="8a200-225">Para crear una suscripción, use la operación /start:</span><span class="sxs-lookup"><span data-stu-id="8a200-225">To create a new subscription, you use the /start operation.</span></span> <span data-ttu-id="8a200-226">En el punto de conexión de la API, use uno de estos valores base en su plan de suscripción:</span><span class="sxs-lookup"><span data-stu-id="8a200-226">For the API endpoint, use one of these values base on your subscription plan:</span></span>

- <span data-ttu-id="8a200-227">Plan para empresas: `manage.office.com`</span><span class="sxs-lookup"><span data-stu-id="8a200-227">Enterprise plan: `manage.office.com`</span></span>

- <span data-ttu-id="8a200-228">Plan de Administración pública GCC: `manage-gcc.office.com`</span><span class="sxs-lookup"><span data-stu-id="8a200-228">GCC government plan: `manage-gcc.office.com`</span></span>

- <span data-ttu-id="8a200-229">Plan de Administración pública GCC High: `manage.office365.us`</span><span class="sxs-lookup"><span data-stu-id="8a200-229">GCC High government plan: `manage.office365.us`</span></span>

- <span data-ttu-id="8a200-230">Plan de Administración pública DoD: `manage.protection.apps.mil`</span><span class="sxs-lookup"><span data-stu-id="8a200-230">DoD government plan: `manage.protection.apps.mil`</span></span>

```powershell
Invoke-WebRequest -Method Post -Headers $headerParams -Uri "https://<YOUR_API_ENDPOINT>/api/v1.0/$tenantGUID/activity/feed/subscriptions/start?contentType=Audit.AzureActiveDirectory"

> [!NOTE]
> Remember that `$headerParams` was populated in the first part of the script listed in the [Connecting to the API](#connecting-to-the-api) section in this article.

The previous code will create a new subscription to the Audit.AzureActiveDirectory content type, with a webhook that is null. You can then check your subscriptions using the code in the [Checking your subscriptions](#checking-your-subscriptions) section in this article.

## Checking content availability

To check what content blobs were created during a certain period, you can add the following line to the script in the “Connecting to the API” section.

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint"
```

<span data-ttu-id="8a200-231">En el ejemplo anterior, se obtienen todas las notificaciones de contenido disponibles el día actual (es decir, desde las 00:00 UTC hasta la hora actual).</span><span class="sxs-lookup"><span data-stu-id="8a200-231">The previous example will get all the content notifications that became available today, which means from 12:00 AM UTC to the current time.</span></span> <span data-ttu-id="8a200-232">Para especificar otro período de tiempo (teniendo en cuenta que el período de tiempo máximo para el que pueden realizarse consultas es de 24 horas), agregue los parámetros *starttime* y *endtime* al URI; por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="8a200-232">If you want to specify a different time period (keeping in mind that the maximum period for which you can query is 24 hours), add the *starttime* and *endtime* parameters to the URI; for example:</span></span>

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint&startTime=2017-10-13T00:00&endTime=2017-10-13T11:59"
```

> [!NOTE]
> <span data-ttu-id="8a200-233">Necesita usar ambos parámetros (*starttime* y *endtime*) o ninguno.</span><span class="sxs-lookup"><span data-stu-id="8a200-233">You must use either both *starttime* and *endtime* parameters or neither.</span></span>

```json
[{      "contentUri" : "https://<your_API_endpoint>/api/v1.0/<your_tenant_guid>/activity/feed/audit/20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentId" : "20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentType" : "Audit.SharePoint",
        "contentCreated" : "2017-10-13T18:00:51.748Z",
        "contentExpiration" : "2017-10-20T18:00:51.748Z",
}]
```

> [!IMPORTANT]
>
> - <span data-ttu-id="8a200-234">La propiedad *contentUri* es el URI desde el que se puede recuperar el blob de contenido.</span><span class="sxs-lookup"><span data-stu-id="8a200-234">The *contentUri* property is the URI from which you can retrieve the content blob.</span></span> <span data-ttu-id="8a200-235">El blob en sí es lo que contiene los detalles del evento; contendrá detalles sobre 1-N eventos.</span><span class="sxs-lookup"><span data-stu-id="8a200-235">The blob itself is what contains the event details; it will contain details about 1 – N events.</span></span> <span data-ttu-id="8a200-236">Aunque puede haber 30 objetos JSON en la colección, es posible que haya muchos más eventos detallados en esos 30 URI de contenido.</span><span class="sxs-lookup"><span data-stu-id="8a200-236">While there may be 30 JSON objects in the collection, there may be many more events detailed in those 30 content URIs.</span></span>
>
> - <span data-ttu-id="8a200-237">La propiedad *contentCreated* no es la fecha en que se creó el evento de la notificación.</span><span class="sxs-lookup"><span data-stu-id="8a200-237">The *contentCreated* property is not the date that the event being notified was created.</span></span> <span data-ttu-id="8a200-238">Se trata de la fecha en que se creó la notificación.</span><span class="sxs-lookup"><span data-stu-id="8a200-238">This is the date the notification was created.</span></span> <span data-ttu-id="8a200-239">Los eventos indicados en el blob puede que se crearan antes que el blob de contenido.</span><span class="sxs-lookup"><span data-stu-id="8a200-239">The events detailed in that blob may have been created well before the content blob was created.</span></span> <span data-ttu-id="8a200-240">Por lo tanto, no se pueden realizar consultas a la API directamente para eventos que se produjeron en un período específico.</span><span class="sxs-lookup"><span data-stu-id="8a200-240">Therefore, you can never query the API directly for events that occurred within any given period.</span></span>

#### <a name="paging-contents-for-busy-tenants"></a><span data-ttu-id="8a200-241">Paginación de contenidos para espacios empresariales con carga elevada</span><span class="sxs-lookup"><span data-stu-id="8a200-241">Paging contents for busy tenants</span></span>

<span data-ttu-id="8a200-242">Un gran número de espacios empresariales de Office 365 tienen miles de eventos que se generan cada hora.</span><span class="sxs-lookup"><span data-stu-id="8a200-242">Many larger Office 365 tenants have thousands of events being generated every hour.</span></span> <span data-ttu-id="8a200-243">Si es el caso de su organización e intenta ejecutar una consulta en un período de 24 horas, como en el ejemplo anterior, puede que necesite recuperar más notificaciones de las que se devuelven en una respuesta.</span><span class="sxs-lookup"><span data-stu-id="8a200-243">If this is the case with your organization, and you try to execute a query for a 24-hour period like in the example above, you may need to retrieve more notifications than can be returned in one response.</span></span> <span data-ttu-id="8a200-244">En ese caso, tendrá que implementar un bucle lógico de algún tipo que compruebe los encabezados de respuesta cada vez para el valor del encabezado **NextPageUrl:**.</span><span class="sxs-lookup"><span data-stu-id="8a200-244">In this case, you'll need to implement a logical loop of some kind, each time checking the response headers for the **NextPageUrl:** header value.</span></span> <span data-ttu-id="8a200-245">Para obtener más información, vea la sección Paginación en la referencia de API de Actividad de administración de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-245">See the Pagination section in the Office 365 Management Activity API reference for more details.</span></span>

```powershell
IF the NextPageUrl header is present in the response... 

THEN issue a new request substituting the Uri parameter in the above Invoke-WebRequest example for the value of the NextPageUrl header...
 
ELSE exit the loop
```

<span data-ttu-id="8a200-246">Puede que resulte difícil probar este código en bucle, a no ser que tenga un espacio empresarial muy activo.</span><span class="sxs-lookup"><span data-stu-id="8a200-246">It will be difficult to test this looping code unless you have a very active tenant.</span></span> <span data-ttu-id="8a200-247">En nuestras pruebas, intentamos ejecutar varios miles de operaciones de actualización en un script y no pudimos generar un número de notificaciones lo suficientemente grande para poder enviar el encabezado **NextPageUrl**.</span><span class="sxs-lookup"><span data-stu-id="8a200-247">In our testing, we tried to execute several thousand update operations in a script and was unable to generate a large enough number of notifications to require the **NextPageUrl** header to be sent.</span></span>

### <a name="using-webhooks"></a><span data-ttu-id="8a200-248">Uso de webhooks</span><span class="sxs-lookup"><span data-stu-id="8a200-248">Using webhooks</span></span>

<span data-ttu-id="8a200-249">Hay dos formas de obtener una notificación que indique que se crearon blobs de contenido.</span><span class="sxs-lookup"><span data-stu-id="8a200-249">There two ways to get a notification that content blobs have been created.</span></span> <span data-ttu-id="8a200-250">El método de *inserción* se implementa con un punto de conexión de webhook, que es una aplicación web creada y hospedada por su cuenta o en una plataforma en la nube.</span><span class="sxs-lookup"><span data-stu-id="8a200-250">The *push* approach is implemented with a webhook endpoint, which is a web application that you create and host yourself or on a cloud platform.</span></span> <span data-ttu-id="8a200-251">El webhook se registra en el momento de crear una suscripción a un tipo de contenido auditado.</span><span class="sxs-lookup"><span data-stu-id="8a200-251">You register the webhook at the time you create a subscription to an audited content type.</span></span> <span data-ttu-id="8a200-252">También puede agregar un registro de webhook a una suscripción existente con el método siguiente.</span><span class="sxs-lookup"><span data-stu-id="8a200-252">You may also add a webhook registration to an existing subscription using the approach shown below.</span></span> <span data-ttu-id="8a200-253">Para usar el método de *inserción*, es necesario realizar una consulta en un intervalo de tiempo específico (no superior a 24 horas) con la operación /content.</span><span class="sxs-lookup"><span data-stu-id="8a200-253">The *pull* approach requires you to query for a particular timespan (no more than 24 hours) using the /content operation.</span></span> <span data-ttu-id="8a200-254">La respuesta indicará los blobs de contenido que se crearon durante el período especificado.</span><span class="sxs-lookup"><span data-stu-id="8a200-254">The response will tell you which content blobs were created during the period specified.</span></span>

<span data-ttu-id="8a200-255">Antes de agregar un webhook, tenga en cuenta los siguientes dos problemas:</span><span class="sxs-lookup"><span data-stu-id="8a200-255">Before you add a webhook, be aware of the following two issues:</span></span>

1. <span data-ttu-id="8a200-256">Microsoft desaconseja el uso de webhooks debido a la dificultad de realizar operaciones de depuración y solución de problemas.</span><span class="sxs-lookup"><span data-stu-id="8a200-256">Webhooks are being de-emphasized by Microsoft because of the difficulty in debugging and troubleshooting.</span></span> <span data-ttu-id="8a200-257">Normalmente, hospedaría un punto de conexión de WebApi que responda a solicitudes entrantes.</span><span class="sxs-lookup"><span data-stu-id="8a200-257">Typically, you would host a WebApi endpoint that responds to incoming requests.</span></span> <span data-ttu-id="8a200-258">Muchos clientes usan entornos de hospedaje (sobre el que no tienen control total) o entornos locales (que tienen dificultades para permitir las solicitudes HTTP entrantes).</span><span class="sxs-lookup"><span data-stu-id="8a200-258">Many customers either use hosting environments (which they don't have full control over) or on-premises environments (that have difficulty allowing incoming HTTP requests).</span></span> <span data-ttu-id="8a200-259">El soporte técnico ha identificado muchos problemas en los que las solicitudes entrantes desde la canalización de auditoría de Office 365 se bloquearon por un firewall o enrutador.</span><span class="sxs-lookup"><span data-stu-id="8a200-259">Support has seen many problems where the incoming requests from the Office 365 auditing pipeline have been blocked by a firewall or router.</span></span> <span data-ttu-id="8a200-260">En este caso, la API implementará un algoritmo de retroceso, que puede resultar confuso y podría deshabilitar el webhook en la suscripción.</span><span class="sxs-lookup"><span data-stu-id="8a200-260">In this case, the API will implement a back-off algorithm, which can be confusing and may result in disabling the webhook in the subscription.</span></span>

2. <span data-ttu-id="8a200-261">El webhook necesita estar preparado para responder de inmediato a una solicitud de validación después de ejecutar la operación de inicio.</span><span class="sxs-lookup"><span data-stu-id="8a200-261">The webhook must be ready to immediately respond to a validation request after the start operation is executed.</span></span> <span data-ttu-id="8a200-262">Si hay un error de código en la aplicación del webhook, la validación producirá errores y no se habilitará el webhook.</span><span class="sxs-lookup"><span data-stu-id="8a200-262">If there is a bug in the webhook application, the validation will fail, and the webhook will not be enabled.</span></span> <span data-ttu-id="8a200-263">Para obtener información sobre el esquema de solicitud de validación, vea la sección Validación de webhook en la referencia de API de Actividad de administración de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-263">For information about the validation request schema, see the Webhook validation section in the Office 365 Management Activity API reference.</span></span> <span data-ttu-id="8a200-264">Es muy recomendable que tenga en cuenta las dificultades de producir un webhook preparado para entornos de producción con el fin de responder a notificaciones de la API de actividad de administración.</span><span class="sxs-lookup"><span data-stu-id="8a200-264">You should seriously consider the challenges in producing a production-ready webhook to respond to Management Activity API notifications.</span></span>

<span data-ttu-id="8a200-265">Si decide implementar un webhook, es necesario probarlo para verificar que el punto de conexión esté preparado para proporcionar una respuesta HTTP 200 (tanto para la solicitud de validación como para las solicitudes de notificación normales) antes de llamar por primera vez a cualquier operación /start que especifique un punto de conexión de webhook.</span><span class="sxs-lookup"><span data-stu-id="8a200-265">If you decide to implement a webhook, it should be tested to verify that the endpoint is prepared to respond with an HTTP 200 response to both the validation request and the normal notification requests before any /start operation that specifies a webhook endpoint is called for the first time.</span></span> <span data-ttu-id="8a200-266">Normalmente, usaría una solicitud ficticia desde la API para probar esta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="8a200-266">Typically, you would use a mocked request from the API to test this readiness.</span></span> <span data-ttu-id="8a200-267">Vea detenidamente las secciones Validación de webhook y Recuperación de contenido en la referencia de API de actividad de administración de Office 365 para comprender el esquema de estos dos tipos de solicitudes.</span><span class="sxs-lookup"><span data-stu-id="8a200-267">Carefully read and observe both the Webhook validation and Retrieving content sections in the Office 365 Management Activity API reference to understand the schema of these two types of requests.</span></span>

<span data-ttu-id="8a200-268">Para agregar una suscripción con un punto de conexión de webhook, agregue un parámetro de cuerpo en la solicitud POST al punto de conexión /start; por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="8a200-268">To add a subscription with a webhook endpoint, add a body parameter to the POST to the /start endpoint; for example:</span></span>

```json
$body = '{
    "webhook" : {
        "address": "https://webhook.myapp.com/o365/",
        "authId": "o365activityapinotification",
        "expiration": ""
    }}'
$uri = "https://manage.office.com/api/v1.0/$tenantGUID/activity/feed//subscriptions/start?contentType=Audit.SharePoint"
Invoke-RestMethod -Method Post -uri $uri -Headers $headerParams -Body $body
```

<span data-ttu-id="8a200-269">Inmediatamente después de esta llamada, se enviará una solicitud de validación a `https://webhook.myapp.com/o365/ …` y es necesario que haya un agente de escucha preparado para responder, según la descripción de la sección Validación de webhook que encontrará en la referencia de API de actividad de administración de Office 365.</span><span class="sxs-lookup"><span data-stu-id="8a200-269">Immediately following this call, a validation request will be sent out to `https://webhook.myapp.com/o365/ …` and there should be a listener ready to respond, as per the description in the Webhook validation section in the Office 365 Management Activity API reference.</span></span> <span data-ttu-id="8a200-270">El agente de escucha tiene que responder con HTTP 200.</span><span class="sxs-lookup"><span data-stu-id="8a200-270">Your listener must respond with HTTP 200.</span></span> <span data-ttu-id="8a200-271">Si ejecuta inmediatamente la operación /list en este momento, no verá el webhook con valores distintos de nulo hasta que la validación devuelva un resultado correcto.</span><span class="sxs-lookup"><span data-stu-id="8a200-271">If you immediately run the /list operation at this point, you will not see the webhook shown as other than null until the validation has returned successfully.</span></span>

#### <a name="checking-notifications-to-webhooks"></a><span data-ttu-id="8a200-272">Comprobar notificaciones a webhooks</span><span class="sxs-lookup"><span data-stu-id="8a200-272">Checking notifications to webhooks</span></span>

<span data-ttu-id="8a200-273">Es importante distinguir entre la operación /notifications y la operación /content.</span><span class="sxs-lookup"><span data-stu-id="8a200-273">It's important to distinguish between the /notifications operation and the /content operation.</span></span> <span data-ttu-id="8a200-274">Comprobar las notificaciones solo es relevante si se suscribió a un punto de conexión de webhook.</span><span class="sxs-lookup"><span data-stu-id="8a200-274">Checking notifications is only relevant if you have subscribed with a webhook endpoint.</span></span> <span data-ttu-id="8a200-275">Esta operación le permitirá conocer si los intentos de envío de notificaciones al webhook se completaron correctamente o no.</span><span class="sxs-lookup"><span data-stu-id="8a200-275">This operation will let you know if attempts to send notifications to your webhook have been successful or not.</span></span> <span data-ttu-id="8a200-276">Esta operación no tiene que usarse para mostrar una lista del contenido disponible.</span><span class="sxs-lookup"><span data-stu-id="8a200-276">This operation should not be used to list available content.</span></span> <span data-ttu-id="8a200-277">Para realizar una comprobación cruzada de la disponibilidad del contenido en comparación con lo que recibió en el webhook, use la operación /content.</span><span class="sxs-lookup"><span data-stu-id="8a200-277">To cross-check the availability of content against what you may have already received in your webhook, you would use the /content operation.</span></span> <span data-ttu-id="8a200-278">Asegúrese de comprobar antes las notificaciones con errores mediante la operación /notifications.</span><span class="sxs-lookup"><span data-stu-id="8a200-278">But be sure to first check for failed notifications using the /notifications operation.</span></span>

### <a name="requesting-content-blobs-and-throttling"></a><span data-ttu-id="8a200-279">Solicitar blobs de contenido y limitación</span><span class="sxs-lookup"><span data-stu-id="8a200-279">Requesting content blobs and throttling</span></span>

<span data-ttu-id="8a200-280">Después de obtener una lista de URI de contenido, necesita solicitar los blobs especificados por los URI.</span><span class="sxs-lookup"><span data-stu-id="8a200-280">After you've obtained a list of content URIs, you must request the blobs specified by the URIs.</span></span> <span data-ttu-id="8a200-281">El siguiente es un ejemplo de solicitud de un blob de contenido (con el punto de conexión de la API manage.office.com para Empresas u organizaciones) mediante PowerShell.</span><span class="sxs-lookup"><span data-stu-id="8a200-281">The following is an example of requesting a content blob (using the manage.office.com API endpoint for Enterprise organizations) using PowerShell.</span></span> <span data-ttu-id="8a200-282">En este ejemplo, se da por hecho que ya usó un ejemplo anterior en la sección [Obtener un token de acceso](#getting-an-access-token) de este artículo para obtener un token de acceso y que lo rellenó con la variable `$headerParams` correspondiente.</span><span class="sxs-lookup"><span data-stu-id="8a200-282">This example assumes you have already used the previous example in the [Getting an access token](#getting-an-access-token) section in this article to get an access token and have populated the `$headerParams` variable appropriately.</span></span>

```powershell
# Get a content blob
$uri = 'https://manage.office.com/api/v1.0/<<your-tenant-guid>>/activity/feed/audit/<<ContentID>$audit_sharepoint$Audit_SharePoint'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

<span data-ttu-id="8a200-283">Tenga en cuenta los siguientes aspectos sobre la variable *$uri* del ejemplo anterior:</span><span class="sxs-lookup"><span data-stu-id="8a200-283">Note the following things about the *$uri* variable in the previous example:</span></span>

- <span data-ttu-id="8a200-284">Usamos comillas simples para que los símbolos *$* no se interpreten como variables en PowerShell.</span><span class="sxs-lookup"><span data-stu-id="8a200-284">We used single quotes so that the *$* symbols aren't interpreted as variables in PowerShell</span></span>

- <span data-ttu-id="8a200-285">Todo el URI se devolverá en la propiedad *contentUri* de la respuesta a la llamada anterior al punto de conexión /content.</span><span class="sxs-lookup"><span data-stu-id="8a200-285">The entire URI will be returned in the *contentUri* property of the response to your previous call to the /content endpoint.</span></span> <span data-ttu-id="8a200-286">Los tokens de marcador de posición solo se muestran con fines ilustrativos.</span><span class="sxs-lookup"><span data-stu-id="8a200-286">The placeholder tokens shown are just for illustration.</span></span>

<span data-ttu-id="8a200-287">Al intentar recuperar los blobs de contenido disponibles, un gran número de clientes (en su mayoría, con espacios empresariales con una gran cantidad de contenido) experimentaron errores similares a estos:</span><span class="sxs-lookup"><span data-stu-id="8a200-287">When attempting to retrieve the available content blobs, many customers (mostly working with busy tenants) have experienced errors that look like this:</span></span>

```json
Response Code 403: {'error':{'code':'AF429','message':'Too many requests. Method=GetBlob, PublisherId=00000000-0000-0000-0000-000000000000'}}
```

<span data-ttu-id="8a200-288">Es probable que esto se deba a la limitación.</span><span class="sxs-lookup"><span data-stu-id="8a200-288">This is likely due to throttling.</span></span> <span data-ttu-id="8a200-289">Tenga en cuenta que es probable que el valor del parámetro PublisherId indique que el cliente no especificó el valor *PublisherIdentifier* en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="8a200-289">Note that the value of the PublisherId parameter likely indicates that the client didn't specify the *PublisherIdentifier* in the request.</span></span> <span data-ttu-id="8a200-290">Además, tenga en cuenta que el nombre de parámetro correcto es *PublisherIdentifier*, incluso aunque vea *PublisherId* en las respuestas de error 403.</span><span class="sxs-lookup"><span data-stu-id="8a200-290">Also, keep in mind that the correct parameter name is *PublisherIdentifier* even though you see *PublisherId* listed in the 403 error responses.</span></span>

> [!NOTE]
> <span data-ttu-id="8a200-291">En la referencia de API, el parámetro *PublisherIdentifier* se muestra en todas las operaciones de la API, pero también tiene que incluirse en la solicitud GET a la URL de contentUri al recuperar el blob de contenido.</span><span class="sxs-lookup"><span data-stu-id="8a200-291">In the API reference, the *PublisherIdentifier* parameter is listed in every operation of the API, but it should also be included in the GET request to the contentUri URL when retrieving the content blob.</span></span>

<span data-ttu-id="8a200-292">Si realiza llamadas API sencillas para la solución de problemas (por ejemplo, para comprobar si una suscripción específica está activa), puede omitir de forma segura el parámetro *PublisherIdentifier*, pero todo el código para entornos de producción tiene que contener el parámetro *PublisherIdentifier* en todas las llamadas.</span><span class="sxs-lookup"><span data-stu-id="8a200-292">If you're doing simple API calls to troubleshoot problems (for example, checking if a given subscription is active) you can safely omit the *PublisherIdentifier* parameter, but absolutely any code that is eventually meant for production use should include the *PublisherIdentifier* parameter on every call.</span></span>

<span data-ttu-id="8a200-293">Si implementa un cliente para el espacio empresarial de la empresa, *PublisherIdentifier* es el GUID de espacio empresarial.</span><span class="sxs-lookup"><span data-stu-id="8a200-293">If you're implementing a client for your company's tenant, the *PublisherIdentifier* is the Tenant GUID.</span></span> <span data-ttu-id="8a200-294">Si crea un complemento o aplicación de ISV para varios clientes, el elemento *PublisherIdentifier* tiene que ser el GUID del espacio empresarial del ISV, y no el GUID del espacio empresarial de la compañía del usuario final.</span><span class="sxs-lookup"><span data-stu-id="8a200-294">If you are creating an ISV application or add-in for multiple customers, the *PublisherIdentifier* should be the ISV's Tenant GUID, and not the tenant GUID of end user's company.</span></span>

<span data-ttu-id="8a200-295">Si incluye el elemento *PublisherIdentifier* válido, estará en un grupo que tiene permiso para realizar 60 000 solicitudes por minuto por espacio empresarial.</span><span class="sxs-lookup"><span data-stu-id="8a200-295">If you include the valid *PublisherIdentifier*, then you will be in a pool that is allotted 60K requests per minute per tenant.</span></span> <span data-ttu-id="8a200-296">Este es un número de solicitudes excepcionalmente elevado.</span><span class="sxs-lookup"><span data-stu-id="8a200-296">This is an exceptionally large number of requests.</span></span> <span data-ttu-id="8a200-297">Pero, si no incluye el parámetro *PublisherIdentifier*, estará en el grupo general con permiso para realizar 60 000 solicitudes por minuto para todos los espacios empresariales.</span><span class="sxs-lookup"><span data-stu-id="8a200-297">However, if you don't include the *PublisherIdentifier* parameter, you will be in the general pool allotted 60K requests per minute for all tenants.</span></span> <span data-ttu-id="8a200-298">En este caso, es más que probable que se produzcan limitaciones en las llamadas.</span><span class="sxs-lookup"><span data-stu-id="8a200-298">In this case, you will more than likely find that your calls are getting throttled.</span></span> <span data-ttu-id="8a200-299">Para evitar esto, siga este procedimiento para solicitar un blob de contenido con el elemento *PublisherIdentifier*:</span><span class="sxs-lookup"><span data-stu-id="8a200-299">To prevent this, here's how you would request a content blob using the *PublisherIdentifier*:</span></span>

```json
$contentUri = ($response.Content | ConvertFrom-Json).contentUri[0]
$uri = $contentUri + '?PublisherIdentifier=82b24b6d-0591-4604-827b-705d55d0992f'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

<span data-ttu-id="8a200-300">En el ejemplo anterior, se da por hecho que la variable *$response* se rellenó con la respuesta a una solicitud al punto de conexión /content y que en la variable *$headerParams* se incluye un token de acceso válido.</span><span class="sxs-lookup"><span data-stu-id="8a200-300">The previous example assumes that the *$response* variable was populated with the response to a request to the /content endpoint and that the *$headerParams* variable includes a valid access token.</span></span> <span data-ttu-id="8a200-301">El script obtiene el primer elemento de la matriz de los URI de contenido de la respuesta y, después, invoca una llamada GET para descargar ese blob y colocarlo en la variable *$contents*.</span><span class="sxs-lookup"><span data-stu-id="8a200-301">The script grabs the first item in the array of content URIs from the response and then invokes the GET to download that blob and put it in the *$contents* variable.</span></span> <span data-ttu-id="8a200-302">Es probable que el código recorra en bucle la colección contentUri y que emita la llamada GET por cada elemento *contentUri*.</span><span class="sxs-lookup"><span data-stu-id="8a200-302">Your code will likely loop through the contentUri collection, issuing the GET for each *contentUri*.</span></span>
